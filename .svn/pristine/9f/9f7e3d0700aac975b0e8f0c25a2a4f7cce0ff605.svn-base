<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-control" content="no-cache">
<meta http-equiv="Cache" content="no-cache">
<meta charset="UTF-8">
<meta name="viewport"
	content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
<meta name="format-detection" content="telephone=yes" />
<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="../../css/area.css">
<title>生活服务</title>
<style type="text/css">
* {
	margin: 0;
	padding: 0;
}

.html, .body {
	background: #fff;
}

.layui-form-pane {
	margin-bottom: 40px;
}

.addimage {
	border: 1px solid;
	width: 80px;
	height: 80px;
	text-align: center;
	line-height: 80px;
	font-size: 60px;
	margin: 10px auto;
	border-radius: 15px;
	position: relative;
	overflow: hidden;
	background: #fff;
}

.addimage input {
	opacity: 0;
	width: 100%;
	height: 100%;
	position: absolute;
	top: 0;
	left: 0
}

.addimage .show {
	width: 100%;
	padding-bottom: 100%;
	background-image: url("../../image/add1.png");
	overflow: hidden;
	background-position: center center;
	background-repeat: no-repeat;
	-webkit-background-size: cover;
	-moz-background-size: cover;
	background-size: cover;
}

.footer {
	position: fixed;
	bottom: 0;
	width: 100%;
}

/* 地区三级联动开始 */
.form-group {
	margin: 5px 3px;
}

.choosecity {
	display: flex;
	flex-flow: row nowrap;
	justify-content: flex-start;
}

.area-city {
	/* 	border: none; */
	outline: none;
	width: 100%;
}
/* 地区三级联动结束 */
.hi {
	display: none;
}

.must {
	color: #ff0000;
}
</style>
</head>
<body style="background: #fff;">
	<form class="layui-form layui-form-pane" id="form">
		<div class="header">
			<div class="addimage">
				<input type="file" id="file1" accept="image/*" onchange="changepic(this)">
				<div class="show"></div>
			</div>

		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input1">
				公司名称
				<span class="must">*</span>
			</label>
			<div class="layui-input-block">
				<input type="text" name="companyname" class="layui-input" id="input1">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input2">公司简称</label>
			<div class="layui-input-inline">
				<input type="text" name="companyshortname" placeholder="支持用户搜索" class="layui-input" id="input2">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">
				分类
				<span class="must">*</span>
			</label>
			<div class="layui-input-block">
				<select name="servicetypeid">
					<option value=""></option>
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input3">负责人</label>
			<div class="layui-input-inline">
				<input type="text" name="username" class="layui-input" id="input3">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input9">微信号</label>
			<div class="layui-input-inline">
				<input type="text" name="wxnumber" class="layui-input" id="input9">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input4">电话</label>
			<div class="layui-input-inline">
				<input type="text" name="tel" class="layui-input" id="input4">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input5">固话</label>
			<div class="layui-input-inline">
				<input type="text" name="tel1" class="layui-input" id="input5">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input6">城市</label>
			<div class="layui-input-inline">
				<!-- 				<input type="text" name="city" class="layui-input" id="input6"> -->
				<div class="addrescon choosecity">
					<div class="iphone">
						<div class="browser">
							<!--选择地区-->
							<section class="express-area" style="margin:0px;">
								<a id="expressArea" href="javascript:void(0)">
									<dl>
										<dd style="margin-left: 0;padding:0">
											<input type="text" class="area-city layui-input" value="" readonly
												placeholder="省 - 市 - 区/县" />
										</dd>
									</dl>
								</a>
							</section>
							<!--选择地区弹层-->
							<section id="areaLayer" class="express-area-box">
								<header>
									<h3>选择地区</h3>
									<a id="backUp" class="back" href="javascript:void(0)" title="返回"></a> <a id="closeArea"
										class="close" href="javascript:void(0)" title="关闭"></a>
								</header>
								<article id="areaBox">
									<ul id="areaList" class="area-list"></ul>
								</article>
							</section>
							<!--遮罩层-->
							<div id="areaMask" class="mask"></div>
							<!-- 							<div id="areaid" class="hi"></div> -->
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input7">地址</label>
			<div class="layui-input-inline">
				<input type="text" name="address" class="layui-input" id="input7">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label" for="input8">备注</label>
			<div class="layui-input-inline">
				<input type="text" name="memo" class="layui-input" id="input8">
			</div>
		</div>
	</form>

	<div class="footer">
		<button class="layui-btn layui-btn-fluid" onclick="fnSave()">申请入驻</button>
	</div>
	<script type="text/javascript" src="../../js/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="../../js/config.js"></script>
	<script type="text/javascript" src="../../js/doT.min.js"></script>
	<script type="text/javascript" src="../../layui/layui.js"></script>
	<script type="text/javascript" src="../../layui/layer.min.js"></script>
	<script type="text/javascript" src="../../js/jquery.area.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			layer.load(1, {
				shade : false,
				shade : [ 0.3, '#000' ]
			});
			fnGetClass();
		});
	
		// 分类信息
		function fnGetClass() {
			$.ajax({
				url : ip() + 'queryclass.do',
				type : "post",
				data : {},
				dataType : "json",
				success : function(data) {
					var str = "";
					for (var int = 0; int < data.length; int++) {
						str += "<option value='" + data[int].servicetypeid + "'>"
							+ data[int].servicetype + "</option>";
					}
					$("select").append(str);
					layui.use('form', function() {
						form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
						form.render();
					});
					layer.closeAll();
				},
				error : function(data) {
					console.log(data);
					layer.closeAll();
				}
			});
		}
	
		// 申请入驻
		function fnSave() {
			var index = layer.load(1, {
				shade : false,
				shade : [ 0.3, '#000' ]
			});
			var companyname = $("input[name='companyname']").val();
			var companyshortname = $("input[name='companyshortname']").val();
			var servicetypeid = $("select").val();
			var username = $("input[name='username']").val();
			var wxnumber = $("input[name='wxnumber']").val();
			var tel = $("input[name='tel']").val();
			var tel1 = $("input[name='tel1']").val();
			var address = $("input[name='address']").val();
			var memo = $("input[name='memo']").val();
			if (companyname == "" || servicetypeid == "") {
				layer.close(index);
				layer.msg('必填项不能为空！', {
					time : 2000
				});
				return;
			}
			var reg = /^1[3|4|5|6|7|8|9][0-9]{9}$/;
			// 			if (!reg.test(tel)) {
			// 				layer.close(index);
			// 				layer.msg('电话格式不正确！', {
			// 					time : 2000
			// 				});
			// 				return;
			// 			}
	
			var formData = new FormData();
			formData.append("files", $("#file1")[0].files[0]);
			formData.append("companyname", encodeURI(companyname));
			formData.append("companyshortname", encodeURI(companyshortname));
			formData.append("servicetypeid", servicetypeid);
			formData.append("username", encodeURI(username));
			formData.append("tel", tel);
			formData.append("tel1", tel1);
			formData.append("memo", encodeURI(memo));
			formData.append("wxnumber", encodeURI(wxnumber));
			// 			var arr = $("#areaid").html().split("-");
			// 			if (arr != "") {
			// 				formData.append("provinceid", arr[0]);
			// 				formData.append("cityid", arr[1]);
			// 				formData.append("countyid", arr[2]);
			// 			} else {
			// 				formData.append("provinceid", "");
			// 				formData.append("cityid", "");
			// 				formData.append("countyid", "");
			// 			}
	
			// 由于和后台数据的城市信息不一致,手机申请入驻的将地址全部存到address这个字段
			var arr = $(".area-city ").val().split("-");
			var addressstr = "";
			if (arr != "") {
				for (var i = 0, l = arr.length; i < l; i++) {
					addressstr += arr[i].trim();
				}
				addressstr = addressstr + address;
			}
			formData.append("address", encodeURI(addressstr));
	
			$.ajax({
				url : ip() + 'savebusiness.do',
				type : 'post',
				dataType : 'json',
				data : formData,
				// 				async : false,
				contentType : false,
				processData : false, //这个很有必要，不然不行
				mimeType : "multipart/form-data",
				success : function(data) {
					console.log(data);
					layer.close(index);
					if (data.flag == "") {
						layer.alert('申请成功', {
							btnAlign : 'c',
							closeBtn : 0
						}, function(index) {
							layer.close(index);
							// 							window.location.reload();
							history.go(-1);
						});
					} else {
						layer.alert(data.flag, {
							btnAlign : 'c',
							closeBtn : 0
						}, function(index) {
							layer.close(index);
							window.location.reload();
						});
					}
				},
				error : function(data) {
					layer.close(index);
					layer.alert('申请失败!', {
						btnAlign : 'c',
						closeBtn : 0
					}, function(index) {
						layer.close(index);
					// 						window.location.reload();
					});
					console.log(data);
				}
			});
		}
	
		// 改变事件显示图片
		function changepic(obj) {
			var check = checkFileSize();
			if (check) {
				var newsrc = getObjectURL(obj.files[0]);
				$(".show").css("background-image", "url(" + newsrc + ")");
			}
		}
		//建立一個可存取到該file的url
		function getObjectURL(file) {
			var url = null;
			// 下面函数执行的效果是一样的，只是需要针对不同的浏览器执行不同的 js 函数而已
			if (window.createObjectURL != undefined) { // basic
				url = window.createObjectURL(file) ;
			} else if (window.URL != undefined) { // mozilla(firefox)
				url = window.URL.createObjectURL(file) ;
			} else if (window.webkitURL != undefined) { // webkit or chrome
				url = window.webkitURL.createObjectURL(file) ;
			}
			return url;
		}
	
		/* 检查图片大小,支持IE、filefox、chrome */
		function checkFileSize() {
			var filepath = $("#file1").val();
			var maxsize = 1 * 1024 * 1024;
			var errMsg = "上传的头像文件不能超过1M喔！！！";
			var tipMsg = "您的浏览器暂不支持上传头像，确保上传文件不要超过1M，建议使用IE、FireFox、Chrome浏览器。";
	
			var filesize = 0;
			var ua = window.navigator.userAgent;
			if (ua.indexOf("MSIE") >= 1) {
				//IE
				var img = new Image();
				img.src = filepath;
				filesize = img.fileSize;
			} else {
				filesize = $("#file1")[0].files[0].size; //byte
			}
			if (filesize > 0 && filesize > maxsize) {
				alert(errMsg);
				return false;
			} else if (filesize == -1) {
				alert(tipMsg);
				return false;
			}
			return true;
		}
	</script>
</body>
</html>