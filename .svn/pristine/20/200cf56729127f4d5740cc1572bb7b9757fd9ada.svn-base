<!DOCTYPE html>
<html>
<head>
<title>收货地址管理</title>
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-control" content="no-cache">
<meta http-equiv="Cache" content="no-cache">
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
<link rel="stylesheet" type="text/css" href="../css/styles.css">
<style type="text/css">
html, body {
	-webkit-tap-highlight-color: rgba(0, 0, 0, 0)
}

html {
	height: 100%;
}

body {
	min-height: 100%;
	background-color: #ffffff;
}

.container, .choose {
	display: block;
	width: 100%;
	height: auto;
	cursor: pointer;
	background-color: #fff;
}

.choose {
	padding-bottom: 40px;
}

.content, .choose.content1 {
	position: relative;
}

.content {
	border: 1px solid #ddd;
}

.address {
	position: relative;
	box-sizing: border-box;
	width: 100%;
	height: auto;
	margin-bottom: 1px;
	padding: 8px 16px;
}

.sign {
	position: absolute;
	top: 2px;
	left: 8px;
	/*width: 35px;*/
	height: 30px;
	line-height: 30px;
	font-size: 14px;
	color: #444;
	text-align: center;
}

.address .sign-1 {
	display: block;
}

.address .info {
	position: relative;
	box-sizing: border-box;
	padding-right: 28px;
	width: 100%;
	height: auto;
}

.address .info .top {
	position: relative;
	box-sizing: border-box;
	width: 100%;
	height: 32px;
	color: #444;
	line-height: 32px;
	font-size: 14px;
}

.address .info .top .consignee {
	display: inline;
	width: auto;
}

.address .info .top .mobile {
	display: inline;
	width: auto;
	position: absolute;
	right: 10px;
}

.address .info .bottom {
	position: relative;
	width: 100%;
	min-height: 32px;
	line-height: 32px;
	color: #888;
	font-size: 14px;
}

.address .info .bottom .type {
	display: inline;
	width: auto;
	color: #3688AE;
	font-weight: bolder;
}

.address .info .bottom .text {
	display: inline;
	width: auto;
}

.address .arrow {
	position: absolute;
	right: 18px;
	top: 32px;
	width: 14px;
	height: 18px;
	background-image: url(../image/more.png);
	background-repeat: no-repeat;
	background-size: 16px 16px;
	background-position: right center;
}

.highlight {
	opacity: 0.7;
}

.operation {
	width: 100%;
	text-align: right;
	color: #666;
	height: 36px;
	line-height: 36px;
}

.delete, .update {
	display: inline-block;
	text-align: center;
	font-size: 15px;
	padding: 0px 15px 0px 0px;
}

.edit {
	width: 20px;
	height: 30px;
	background-image: url(../image/edit.png);
	background-repeat: no-repeat;
	background-size: auto 14px;
	background-position: center 6px;
	vertical-align: middle;
}

.delpic {
	width: 20px;
	height: 30px;
	background-image: url(../image/delete.png);
	background-repeat: no-repeat;
	background-size: auto 14px;
	background-position: center 6px;
	vertical-align: middle;
}

.hi {
	display: none;
}

.newaddress {
	width: 100%;
	height: 40px;
	line-height: 40px;
	text-align: center;
	padding: 3px 5px;
	border-top: 1px solid #ccc;
	color: #666;
	font-size: 18px;
	background: #66CDAA;
	position: fixed;
	bottom: 0px;
}
</style>
</head>
<body>
	<div class="container">
		<script type="text/template" charset="utf-8" id="content">
			{{ for(var i=0;i< it.length;i++) { }}
			<div class="content">
			<div class="appreceiveaddressid hi">{{=it[i].appreceiveaddressid}}</div>
			<div class="address" onclick="updateaddress('{{=it[i].appreceiveaddressid}}','1')">
			<div class="info">
			<div class="top">
			<div class="consignee">
			收货人：<span class="username">{{=it[i].receivename}}</span>
			</div>
			<div class="mobile">{{=it[i].phonenumber}}</div>
			</div>
			<div class="bottom">
			<div class="text">{{=it[i].province}}{{=it[i].city}}{{=it[i].area}}{{=it[i].address}}</div>
			</div>
			</div>
			</div>
			<div style="position: relative;">
			<div class="sign" onclick="fnSetDefAddress('{{=it[i].appreceiveaddressid}}')">
			<span class="signtext hi">{{=it[i].sign}}</span>
			<span class="moren">[设为默认]</span>
			</div>
			<div class="operation">
			<span class="edit"></span>
			<div class="update" onclick="updateaddress('{{=it[i].appreceiveaddressid}}','1')">
			编辑
			</div>
			<span class="delpic"></span>
			<div class="delete" onclick="deleteAddress('{{=it[i].appreceiveaddressid}}')">
			删除
			</div>
			</div>
			</div>
			</div>
			{{ } }}
		</script>
	</div>
	<div class="choose">
		<script type="text/template" charset="utf-8" id="content1">
	{{ for(var i=0;i< it.length;i++) { }}
	<div class="content">
		<div class="address" onclick="updateaddress('{{=it[i].appreceiveaddressid}}','2')">
			<div class="info">
				<div class="top">
					<div class="consignee">
						收货人：
						<span class="username">{{=it[i].receivename}}</span>
					</div>
					<div class="mobile">{{=it[i].phonenumber}}</div>
				</div>
				<div class="bottom">
					<div class="text">{{=it[i].province}}{{=it[i].city}}{{=it[i].area}}{{=it[i].address}}</div>
				</div>
			</div>
		</div>
	</div>
	{{ } }}
	</script>
	</div>
	<div onclick="updateaddress('','0')" class="newaddress">新增收货地址</div>
</body>
<script type="text/javascript" src="../js/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="../js/config.js"></script>
<script type="text/javascript" src="../js/doT.min.js"></script>
<script type="text/javascript" src="../js/layer/mobile/layer.js"></script>
<script type="text/javascript">
	var user,
		orderflag,
		address; // orderflag 判断正常进入页面或订单选择收货地址
	$(document).ready(function() {
		fnGetAddress();
		orderflag = getParameter("orderflag");
	});

	// 特殊监听返回
	pushHistory();
	window.addEventListener("popstate", function(e) {
		if (orderflag != 2) {
			window.location.href = "../index.html?flag=4";
		} else {
			history.go(-1);
		}
	}, false);
	function pushHistory() {
		var state = {
			title : "title",
			url : "#"
		};
		window.history.pushState(state, "title", "#");
	}

	// 所有收货地址
	function fnGetAddress() {
		user = $.parseJSON(window.localStorage.getItem("user"));
		if (jQuery.isEmptyObject(user) || user.userid == "-1"
			|| user.userid == 'undefined' || user.userid == undefined) {
			layer.open({
				content : "你还没有注册，确定注册吗？",
				shadeClose : false,
				btn : [ '确定', '不要' ],
				yes : function(index) {
					window.location.href = "register.html?" + timestamp();
				},
				no : function() {
					window.history.back();
				}
			});
			return;
		}
		var index = layer.open({
			shadeClose : false,
			type : 2
		});
		$.ajax({
			url : ip() + 'getaddress.do',
			type : "post",
			data : {
				userid : user.userid
			},
			dataType : "json",
			success : function(data) {
				if (orderflag == 2) {
					layer.close(index);
					$(".choose").html(doT.template($("#content1").text())(data));
				} else {
					layer.close(index);
					$(".container").html(doT.template($("#content").text())(data));
					if (data.length > 0) {
						fnsetSign();
					}
				}
			},
			error : function(data) {
				layer.close(index);
			}
		});

	}
	// 检查默认地址
	function fnsetSign() {
		var s = $(".signtext");
		var a = $(".moren");
		var def = 0;
		for (var i = 0; i < s.length; i++) {
			if ((s[i].innerHTML) == '1') {
				a[i].innerHTML = "[默认地址]";
				a[i].style.color = '#ff0000';
				def = 1;
			}
		}
		if (def == 0) {
			var appreceiveaddressids = $(".appreceiveaddressid");
			a[0].innerHTML = "[默认地址]";
			a[0].style.color = '#ff0000';
			fnSetDefAddress(appreceiveaddressids[0].innerHTML);
		}
	}

	//点击删除按钮方法
	function deleteAddress(id_) {
		layer.open({
			content : "确定要删除收货地址吗？",
			shadeClose : false,
			btn : [ '确定', '不要' ],
			yes : function(index) {
				$.ajax({
					url : ip() + 'deleteaddress.do',
					type : "post",
					data : {
						userid : user.userid,
						id : id_
					},
					dataType : "json",
					success : function(data) {
						layer.close(index);
						window.location.reload();
					},
					error : function(data) {
						layer.close(index);
						window.location.reload();
					}
				});
			}
		});
	}

	//点击详细地址信息，进入修改信息页面 flag判断0是新增1是修改2是切换收货地址
	function updateaddress(id_, flag_) {
		var oEvent = event;
		oEvent.stopPropagation();
		if (flag_ == 2) {
			$.ajax({
				url : ip() + 'getupdateaddressinfo.do',
				type : "post",
				data : {
					userid : user.userid,
					id : id_
				},
				dataType : "json",
				success : function(data) {
					history.go(-1);
				}
			});
		} else if (flag_ == 1) {
			window.location.href = "addaddress.html?id=" + id_ + "&flag=" + flag_ + "&" + timestamp();
		} else if (flag_ == 0) {
			if (orderflag == 2) {
				window.location.href = "addaddress.html?orderflag=2&" + timestamp();
			} else {
				window.location.href = "addaddress.html?" + timestamp();
			}
		}
	}

	// 选择收货地址
	function fnChoose(id_) {
		$.ajax({
			url : ip() + 'getupdateaddressinfo.do',
			type : "post",
			data : {
				userid : user.userid,
				id : id_
			},
			dataType : "json",
			success : function(data) {
				history.go(-5);
			}
		});
	}

	// 点击切换默认地址
	function fnSetDefAddress(id_) {
		var oEvent = event;
		oEvent.stopPropagation();
		$.ajax({
			url : ip() + 'setdefaddress.do',
			type : "post",
			data : {
				id : id_,
				userid : user.userid
			},
			dataType : "json",
			success : function(data) {
				window.location.reload();
			},
		//				error : function(data) {
		//					window.location.reload();
		//				}
		});
	}
</script>
</html>
